<html>
    <body>
        <br>
        <div class="divStyle">
            <canvas class="canvasStyle" id="canvas" width=400 height=600></canvas>
        </div>
        <div class="divStyle">
            <canvas class="floor" width=400 height=50></canvas>
        </div>
    </body>
    <style>
        .divStyle{
            margin: auto;
            text-align:center;
        }
        .floor{
            background: rgb(109, 20, 64);
        }
        .canvasStyle{
            background: rgb(250, 230, 255);
        }
    </style>
    <script>
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var screen = new Array(600);
        var rotation;
        var stateCode;
        var x, y;
        var i, j;
        var a;
        context.strokeStyle = "rgb(109, 20, 64)";
        context.fillStyle = "black";

        window.onkeydown = function(){
            if(event.keyCode===37){ stateCode = 1; }    // left
            if(event.keyCode===38){ stateCode = 2; }    // up - rotation
            if(event.keyCode===39){ stateCode = 3; }    // right
            if(event.keyCode===40){ stateCode = 4; }    // down
        }

        function init(){
            y = 0;
            rotation = 0;
            a = Math.floor(Math.random()*7);
        }

        
        function block_0(){
            if(rotation%2===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.fillRect(20*x,20*(y+3),20,20);
                context.closePath();
            }
            else{
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+2),20*y,20,20);
                context.fillRect(20*(x+3),20*y,20,20);
                context.closePath();
            }
        }
        
        function block_1(){
            context.beginPath();
            context.fillRect(20*x,20*y,20,20);
            context.fillRect(20*x,20*(y+1),20,20);
            context.fillRect(20*(x+1),20*y,20,20);
            context.fillRect(20*(x+1),20*(y+1),20,20);
            context.closePath();
        }

        function block_2(){
            if(rotation%4===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x-1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.closePath();
            }
            else if(rotation%4===1){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.closePath();
            }
            else if(rotation%4===2){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+2),20*y,20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.closePath();
            }
            else{   // rotation%4===3
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x-1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.closePath();
            }
        }

        function block_3(){
            if(rotation%4===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.fillRect(20*(x+1),20*(y+2),20,20);
                context.closePath();
            }
            else if(rotation%4===1){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+2),20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.closePath();
            }
            else if(rotation%4===2){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+2),20,20);
                context.closePath();
            }
            else{
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x-2),20*(y+1),20,20);
                context.fillRect(20*(x-1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.closePath();
            }
        }

        function block_4(){
            if(rotation%4===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x-1),20*(y+2),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.closePath();
            }
            else if(rotation%4===1){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.fillRect(20*(x+2),20*(y+1),20,20);
                context.closePath();
            }
            else if(rotation%4===2){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*x,20*(y+2),20,20);
                context.closePath();
            }
            else{
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+2),20*y,20,20);
                context.fillRect(20*(x+2),20*(y+1),20,20);
                context.closePath();
            }
        }

        function block_5(){
            if(rotation%2===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.fillRect(20*(x+2),20*(y+1),20,20);
                context.closePath();
            }
            else{
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x-1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x-1),20*(y+2),20,20);
                context.closePath();
            }
        }

        function block_6(){
            if(rotation%2===0){
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*(x+1),20*y,20,20);
                context.fillRect(20*(x-1),20*(y+1),20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.closePath();
            }
            else{
                context.beginPath();
                context.fillRect(20*x,20*y,20,20);
                context.fillRect(20*x,20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+1),20,20);
                context.fillRect(20*(x+1),20*(y+2),20,20);
                context.closePath();
            }
        }

        function moveBlock(){
            var timecount = requestAnimationFrame(moveBlock);
            context.clearRect(0,0,600,600);
            printScreen();
            if(a===0){
                if(stateCode===1){ 
                    if(x>0){ x--; stateCode=0; } 
                }
                if(stateCode===3){
                    if(rotation%2===0){
                        if(x<19){ x++; stateCode=0; }
                    }
                    else{
                        if(x+3 < 19){ x++; stateCode=0; }
                    }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+3 > 19){ x -= 3; }
                    stateCode=0;
                }

                block_0();
                testBlock(a);
            }
            else if(a===1){
                if(stateCode===1){ 
                    if(x>0){ x--; stateCode=0; } 
                }
                if(stateCode===3){
                   if(x<18){ x++; stateCode=0; }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){ rotation++; stateCode=0; }

                block_1();
                testBlock(a);
            }
            else if(a===2){
                if(stateCode===1){ 
                    if(rotation%4===0||rotation%4===3){
                        if(x>1){ x--; stateCode=0; }
                    }
                    else{
                        if(x>0){ x--; stateCode=0; }
                    }
                }
                if(stateCode===3){
                    if(rotation%4===2){
                        if(x+2 < 19){ x++; stateCode=0; }
                    }
                    else if(rotation%4===3){
                        if(x<19){ x++; stateCode=0; }
                    }
                    else{
                        if(x+1 < 19){ x++; stateCode=0; }
                    }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+2 > 19){ x -= 1; }
                    if(x-1 < 0){ x += 1; }
                    stateCode=0;
                }

                block_2();
                testBlock(a);
            }
            else if(a===3){
                if(stateCode===1){ 
                    if(rotation%4===3){
                        if(x>2){ x--; stateCode=0; }
                    }
                    else{
                        if(x>0){ x--; stateCode=0; }
                    }
                }
                if(stateCode===3){
                    if(rotation%4===0){
                        if(x+1 < 19){ x++; stateCode=0; }
                    }
                    else if(rotation%4===1){
                        if(x+2 < 19){ x++; stateCode=0; }
                    }
                    else{
                        if(x<19){ x++; stateCode=0; }
                    }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+2 > 19){ x -=2; }
                    else if(x+1 > 19){ x--; }
                    if(x-2 < 0){ x += 2;}
                    else if(x-1 < 0){ x++; }
                    stateCode=0;
                }

                block_3();
                testBlock(a);
            }
            else if(a===4){
                if(stateCode===1){ 
                    if(rotation%4===0){
                        if(x>1){ x--; stateCode=0; }
                    }
                    else{
                        if(x>0){ x--; stateCode=0; }
                    }
                }
                if(stateCode===3){
                    if(rotation%4===0){
                        if(x<19){ x++; stateCode=0;}
                    }
                    else if(rotation%4===2){
                        if(x+1 < 19){ x++; stateCode=0; }
                    }
                    else{
                        if(x+2 < 19){ x++; stateCode=0; }
                    }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+1 > 19){ x--; }
                    else if(x+2 > 19){x -= 2;}
                    if(x-2 < 0){ x += 2; }
                    else if(x-1 < 0){ x++; }
                    stateCode=0;
                }

                block_4();
                testBlock(a);
            }
            else if(a===5){
                if(stateCode===1){
                    if(rotation%2===0){
                        if(x>0){ x--; stateCode = 0;}
                    }
                    else{
                        if(x>1){ x--; stateCode = 0;}
                    }
                }
                if(stateCode===3){
                    if(rotation%2===0){
                        if(x+2 < 19){ x++; stateCode = 0; }
                    }
                    else{
                        if(x<19){ x++; stateCode = 0; }
                    }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+2 > 19){ x -= 2; }
                    if(x-1 < 0){ x++; }
                    stateCode = 0;
                }

                block_5();
                testBlock(a);
            }
            else{   // a===6
                if(stateCode===1){
                    if(rotation%2===0){
                        if(x>1){ x--; stateCode = 0;}
                    }
                    else{
                        if(x>0){ x--; stateCode = 0;}
                    }
                }
                if(stateCode===3){
                    if(x+1 < 19){ x++; stateCode = 0; }
                }
                if(stateCode===4){ 
                    if(timecount%3===0){y++; stateCode=0; }
                }
                if(stateCode===2){
                    rotation++;
                    if(x+1 > 19){ x--; }
                    if(x-1 < 0){ x++; }
                    stateCode = 0;
                }


                block_6();
                testBlock(a);
            }

            deleteLine();
            if(timecount%37===0){
                y++;
                if(testEnd()){
                cancelAnimationFrame(timecount);
                setTimeout(function(){ alert("Game Over!\n"); },100);
                }
            }
        }

        function printScreen(){
            for(i=0;i<20;i++){
                for(j=0;j<30;j++){
                    let k = 20*j + i;   //
                    if(screen[k]===1){
                        context.beginPath();
                        context.fillRect(20*i,20*j,20,20);
                        context.closePath();
                    }
                }
            }
        }

        function testBlock(a1){
            let t1 = a1;
            switch(t1){
                case 0:
                    if(rotation%2===0){
                        let k = 20*(y+4) + x;
                        if(y===26){ fixBlock(t1); }
                        else if(screen[k]===1){ fixBlock(t1); }
                    }
                    else{
                        let k = 20*(y+1) + x;
                        if(y===29){ fixBlock(t1); }
                        else{
                            for(i=0;i<4;i++){
                                if(screen[k+i]===1){ fixBlock(t1); }
                            }
                        }
                    }
                    break;
                case 1:
                    let k = 20*(y+2) + x;
                    if(y===28){ fixBlock(t1); }
                    else if(screen[k]===1||screen[k+1]===1){ fixBlock(t1); }
                    break;
                case 2:
                    if(rotation%4===0||rotation%4===2){
                        if(y===28){ fixBlock(t1); }
                        else if(rotation%4===0){
                            let k = 20*(y+2) + x;
                            for(i=0;i<3;i++){
                                if(screen[k-1+i]===1){ fixBlock(t1); }
                            }
                        }
                        else{
                            let k = 20*(y+2) + x+1;
                            if(screen[k]===1){ fixBlock(t1); }
                            else if(screen[k-21]===1){ fixBlock(t1); }
                            else if(screen[k-19]===1){ fixBlock(t1); }
                        }
                    }
                    else{
                        let k = 20*(y+3) + x;
                        if(y===27){ fixBlock(t1); }
                        if(screen[k]===1){ fixBlock(t1); }
                        if(rotation%4===1){
                            if(screen[k-19]===1){ fixBlock(t1); }
                        }
                        else{
                            if(screen[k-21]===1){ fixBlock(t1); }
                        }
                    }
                    break;
                case 3:
                    if(rotation%4===1||rotation%4===3){
                        let k = 20*(y+2) + x;
                        if(y===28){ fixBlock(t1); }
                        else if(rotation%4===1){
                            if(screen[k]===1){ fixBlock(t1); }
                            else if(screen[k-18]===1){ fixBlock(t1); }
                            else if(screen[k-19]===1){ fixBlock(t1); }
                        }
                        else{
                            for(i=0;i<3;i++){
                                if(screen[k-2+i]===1){ fixBlock(t1); }
                            }
                        }
                    }
                    else{
                        let k = 20*(y+3) + x;
                        if(y===27){ fixBlock(t1); }
                        else if(rotation%4===0){
                            for(i=0;i<2;i++){
                                if(screen[k+i]===1){ fixBlock(t1); }
                            }
                        }
                        else{
                            if(screen[k+1]===1){ fixBlock(t1); }
                            else if(screen[k-40]===1){ fixBlock(t1); }
                        }
                    }
                    break;
                case 4:
                    if(rotation%4===1||rotation%4===3){
                        let k = 20*(y+2) + x;
                        if(y===28){ fixBlock(t1); }
                        else if(rotation%4===1){
                            for(i=0;i<3;i++){
                                if(screen[k+i]===1){ fixBlock(t1); }
                            }
                        }
                        else{
                            if(screen[k+2]===1){ fixBlock(t1); }
                            else if(screen[k-19]===1){ fixBlock(t1); }
                            else if(screen[k-20]===1){ fixBlock(t1); }
                        }
                    }
                    else{
                        let k = 20*(y+3) + x;
                        if(y===27){ fixBlock(t1); }
                        else if(rotation%4===0){
                            for(i=0;i<2;i++){
                                if(screen[k-1+i]===1){ fixBlock(t1); }
                            }
                        }
                        else{
                            if(screen[k]===1){ fixBlock(t1); }
                            else if(screen[k-39]===1){ fixBlock(t1); }
                        }
                    }
                    break;
                case 5:
                    if(rotation%2===0){
                        let k = 20*(y+2) + x;
                        if(y===28){ fixBlock(t1); }
                        else if(screen[k+1]===1){ fixBlock(t1); }
                        else if(screen[k+2]===1){ fixBlock(t1); }
                    }
                    else{
                        let k = 20*(y+3) + x;
                        if(y===27){ fixBlock(t1); }
                        else if(screen[k-1]===1){ fixBlock(t1); }
                        else if(screen[k-20]===1){ fixBlock(t1); }
                    }
                    break;
                case 6:
                    if(rotation%2===0){
                        let k = 20*(y+2) + x;
                        if(y===28){ fixBlock(t1); }
                        else if(screen[k-1]===1){ fixBlock(t1); }
                        else if(screen[k]===1){ fixBlock(t1); }
                    }
                    else{
                        let k = 20*(y+3) + x;
                        if(y===27){ fixBlock(t1); }
                        else if(screen[k+1]===1){ fixBlock(t1); }
                        else if(screen[k-20]===1){ fixBlock(t1); }
                    }
                    break;
            }
        }
        
        function fixBlock(a2){
            let k = 20*y + x;
            let t2 = a2;
            screen[k] = 1;
            switch(t2){
                case 0:
                    if(rotation%2===0){
                        screen[k+20] = 1;
                        screen[k+40] = 1;
                        screen[k+60] = 1;
                    }
                    else{
                        screen[k+1] = 1;
                        screen[k+2] = 1;
                        screen[k+3] = 1;
                    }
                    break;
                case 1:
                    screen[k+1] = 1;
                    screen[k+20] = 1;
                    screen[k+21] = 1;
                    break;
                case 2:
                    if(rotation%4===0){
                        screen[k+19] = 1;
                        screen[k+20] = 1;
                        screen[k+21] = 1;
                    }
                    else if(rotation%4===1){
                        screen[k+20] = 1;
                        screen[k+21] = 1;
                        screen[k+40] = 1;
                    }
                    else if(rotation%4===2){
                        screen[k+1] = 1;
                        screen[k+2] = 1;
                        screen[k+21] = 1;
                    }
                    else{   // rotation%4===3
                        screen[k+19] = 1;
                        screen[k+20] = 1;
                        screen[k+40] = 1;
                    }
                    break;
                case 3:
                    if(rotation%4===0){
                        screen[k+20] = 1;
                        screen[k+40] = 1;
                        screen[k+41] = 1;
                    }
                    else if(rotation%4===1){
                        screen[k+1] = 1;
                        screen[k+2] = 1;
                        screen[k+20] = 1;
                    }
                    else if(rotation%4===2){
                        screen[k+1] = 1;
                        screen[k+21] = 1;
                        screen[k+41] = 1;
                    }
                    else{   // rotation%4===3
                        screen[k+18] = 1;
                        screen[k+19] = 1;
                        screen[k+20] = 1;
                    }
                    break;
                case 4:
                    if(rotation%4===0){
                        screen[k+20] = 1;
                        screen[k+39] = 1;
                        screen[k+40] = 1;
                    }
                    else if(rotation%4===1){
                        screen[k+20] = 1;
                        screen[k+21] = 1;
                        screen[k+22] = 1;
                    }
                    else if(rotation%4===2){
                        screen[k+1] = 1;
                        screen[k+20] = 1;
                        screen[k+40] = 1;
                    }
                    else{
                        screen[k+1] = 1;
                        screen[k+2] = 1;
                        screen[k+22] = 1;
                    }
                    break;
                case 5:
                    if(rotation%2===0){
                        screen[k+1] = 1;
                        screen[k+21] = 1;
                        screen[k+22] = 1;
                    }
                    else{
                        screen[k+19] = 1;
                        screen[k+20] = 1;
                        screen[k+39] = 1;
                    }
                    break;
                case 6:
                    if(rotation%2===0){
                        screen[k+1] = 1;
                        screen[k+19] = 1;
                        screen[k+20] = 1;
                    }
                    else{
                        screen[k+20] = 1;
                        screen[k+21] = 1;
                        screen[k+41] = 1;
                    }
                    break;
            }
            init();
        }

        function deleteLine(){
            let q;
            for(j=29;j>0;j--){
                let p = 0;
                while(p<20){
                    let k = 20*j +p;
                    q = 0;
                    if(screen[k]===0){ break; }
                    q = 1;  // 한 줄이 모두 꽉 찼으면 q는 1 아니면 0
                    p++;
                }
                if(q===1){
                    for(i=j;i>0;i--){
                        for(let l=0;l<20;l++){
                            let k = 20*i +l;
                            screen[k] = screen[k-20];
                        }
                    }
                    j += 1;
                }
            }        
        }

        function testEnd(){
            for(i=0;i<20;i++){
                if(screen[i]===1){ return true; }
            }
            return false;
        }
        
        x = 9;
        for(i=0;i<600;i++){ screen[i] = 0; }
        init();
        moveBlock();
    </script>
</html>